<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 27.2.

Copyright (C) 1990-1996, 1998-2021 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<!-- Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rev="made" href="mailto:bug-gnu-emacs@gnu.org">
<link rel="icon" type="image/png" href="/graphics/gnu-head-mini.png">
<meta name="ICBM" content="42.256233,-71.006581">
<meta name="DC.title" content="gnu.org">

<style type="text/css">
@import url('/software/emacs/manual.css');
</style>
</head>

<body lang="en">
<span id="Filter-Functions"></span><div class="header" style="background-color:#DDDDFF">
<p>
Next: <a href="Decoding-Output.html" accesskey="n" rel="next">Decoding Output</a>, Previous: <a href="Process-Buffers.html" accesskey="p" rel="prev">Process Buffers</a>, Up: <a href="Output-from-Processes.html" accesskey="u" rel="up">Output from Processes</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>

<span id="Process-Filter-Functions"></span><h4 class="subsection">38.9.2 Process Filter Functions</h4>
<span id="index-filter-function"></span>
<span id="index-process-filter"></span>

<span id="index-default-filter-function-of-a-process"></span>
<p>A process <em>filter function</em> is a function that receives the
standard output from the associated process.  <em>All</em> output from
that process is passed to the filter.  The default filter simply
outputs directly to the process buffer.
</p>
<p>By default, the error output from the process, if any, is also
passed to the filter function, unless the destination for the standard
error stream of the process was separated from the standard output
when the process was created.  Emacs will only call the filter
function during certain function calls.  See <a href="Output-from-Processes.html">Output from Processes</a>.
Note that if any of those functions are called by the filter, the
filter may be called recursively.
</p>
<p>A filter function must accept two arguments: the associated process
and a string, which is output just received from it.  The function is
then free to do whatever it chooses with the output.
</p>
<p>Quitting is normally inhibited within a filter function&mdash;otherwise,
the effect of typing <kbd>C-g</kbd> at command level or to quit a user
command would be unpredictable.  If you want to permit quitting inside
a filter function, bind <code>inhibit-quit</code> to <code>nil</code>.  In most
cases, the right way to do this is with the macro
<code>with-local-quit</code>.  See <a href="Quitting.html">Quitting</a>.
</p>
<p>If an error happens during execution of a filter function, it is
caught automatically, so that it doesn&rsquo;t stop the execution of whatever
program was running when the filter function was started.  However, if
<code>debug-on-error</code> is non-<code>nil</code>, errors are not caught.
This makes it possible to use the Lisp debugger to debug filter
functions.  See <a href="Debugger.html">Debugger</a>.
</p>
<p>Many filter functions sometimes (or always) insert the output in the
process&rsquo;s buffer, mimicking the actions of the default filter.
Such filter functions need to make sure that they save the
current buffer, select the correct buffer (if different) before
inserting output, and then restore the original buffer.
They should also check whether the buffer is still alive, update the
process marker, and in some cases update the value of point.  Here is
how to do these things:
</p>
<span id="Process-Filter-Example"></span><div class="example">
<pre class="example">(defun ordinary-insertion-filter (proc string)
  (when (buffer-live-p (process-buffer proc))
    (with-current-buffer (process-buffer proc)
      (let ((moving (= (point) (process-mark proc))))
</pre><pre class="example">        (save-excursion
          ;; <span class="roman">Insert the text, advancing the process marker.</span>
          (goto-char (process-mark proc))
          (insert string)
          (set-marker (process-mark proc) (point)))
        (if moving (goto-char (process-mark proc)))))))
</pre></div>

<p>To make the filter force the process buffer to be visible whenever new
text arrives, you could insert a line like the following just before the
<code>with-current-buffer</code> construct:
</p>
<div class="example">
<pre class="example">(display-buffer (process-buffer proc))
</pre></div>

<p>To force point to the end of the new output, no matter where it was
previously, eliminate the variable <code>moving</code> from the example and
call <code>goto-char</code> unconditionally.  Note that this doesn&rsquo;t
necessarily move the window point.  The default filter actually uses
<code>insert-before-markers</code> which moves all markers, including the
window point.  This may move unrelated markers, so it&rsquo;s generally
better to move the window point explicitly, or set its insertion type
to <code>t</code> (see <a href="Window-Point.html">Window Point</a>).
</p>
<p>Note that Emacs automatically saves and restores the match data
while executing filter functions.  See <a href="Match-Data.html">Match Data</a>.
</p>
<p>The output to the filter may come in chunks of any size.  A program
that produces the same output twice in a row may send it as one batch of
200 characters one time, and five batches of 40 characters the next.  If
the filter looks for certain text strings in the subprocess output, make
sure to handle the case where one of these strings is split across two
or more batches of output; one way to do this is to insert the
received text into a temporary buffer, which can then be searched.
</p>
<dl>
<dt id="index-set_002dprocess_002dfilter">Function: <strong>set-process-filter</strong> <em>process filter</em></dt>
<dd><p>This function gives <var>process</var> the filter function <var>filter</var>.  If
<var>filter</var> is <code>nil</code>, it gives the process the default filter,
which inserts the process output into the process buffer.
</p></dd></dl>

<dl>
<dt id="index-process_002dfilter">Function: <strong>process-filter</strong> <em>process</em></dt>
<dd><p>This function returns the filter function of <var>process</var>.
</p></dd></dl>

<p>In case the process&rsquo;s output needs to be passed to several filters, you can
use <code>add-function</code> to combine an existing filter with a new one.
See <a href="Advising-Functions.html">Advising Functions</a>.
</p>
<p>Here is an example of the use of a filter function:
</p>
<div class="example">
<pre class="example">(defun keep-output (process output)
   (setq kept (cons output kept)))
     &rArr; keep-output
</pre><pre class="example">(setq kept nil)
     &rArr; nil
</pre><pre class="example">(set-process-filter (get-process &quot;shell&quot;) 'keep-output)
     &rArr; keep-output
</pre><pre class="example">(process-send-string &quot;shell&quot; &quot;ls ~/other\n&quot;)
     &rArr; nil
kept
     &rArr; (&quot;lewis@slug:$ &quot;
</pre><pre class="example">&quot;FINAL-W87-SHORT.MSS    backup.otl              kolstad.mss~
address.txt             backup.psf              kolstad.psf
backup.bib~             david.mss               resume-Dec-86.mss~
backup.err              david.psf               resume-Dec.psf
backup.mss              dland                   syllabus.mss
&quot;
&quot;#backups.mss#          backup.mss~             kolstad.mss
&quot;)
</pre></div>



<div class="header" style="background-color:#DDDDFF">
<p>
Next: <a href="Decoding-Output.html" accesskey="n" rel="next">Decoding Output</a>, Previous: <a href="Process-Buffers.html" accesskey="p" rel="prev">Process Buffers</a>, Up: <a href="Output-from-Processes.html" accesskey="u" rel="up">Output from Processes</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
